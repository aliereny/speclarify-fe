# Architecture Overview

Speclarify FE is an interactive Next.js 13 application that wraps a structured requirements refinement workflow. This document maps the key modules, how state flows through the UI, and the conventions that keep the codebase consistent.

## Top-Level Composition
- **App Router** (`src/app`) drives routing. Each feature folder maps to a route segment: the dashboard (`page.tsx`), project wizard (`projects/[projectId]/(steps)`), CRUD screens, and the elicitation flow.
- **Root layout** (`src/app/layout.tsx`) imports global styles, injects the generated Ant Design CSS, and wraps every page in `DashboardLayout` for shared chrome.
- **Dashboard shell** (`src/ui/templates/DashboardLayout.tsx`) renders the Ant Design header, navigation menu, content container, and footer. The header routes between the project dashboard and the elicitation page.

## Workflow Layout
- The multi-step project experience lives under `src/app/projects/[projectId]/(steps)`. Each step is its own page component that pulls data from the requirements store.
- `layout.tsx` inside `(steps)` registers a vertical `Steps` component and provides navigation via `router.push` to maintain the prescribed order:
  1. upload
  2. review
  3. remove-duplicates
  4. remove-inconsistencies
  5. fix-ambiguities
  6. prioritize
  7. classify
  8. export
- Steps share SCSS modules for styling and rely on reusable Ant Design-backed cards from `src/ui/molecules`.

## State Management
- **Zustand stores** in `src/stores` provide the single source of truth. Each store is wrapped in `persist` so data survives page reloads using localStorage.
  - `useAuthStore.ts` keeps `accessToken`/`refreshToken`, exposes login/logout, and allows interceptors to read tokens synchronously.
  - `useProjectStore.ts` caches project lists and offers CRUD actions. API responses may omit `created_at` or `number_of_requirements`, so placeholder values are injected and maintained in state.
  - `useRequirementsStore.ts` orchestrates the entire refinement flow: fetching requirements, parsing uploads, finding duplicates/inconsistencies/ambiguities, CRUD operations, and updating priority/class attributes.
- Components that rely on persisted state call `useIsClient()` (`src/hooks/useIsClient.tsx`) to avoid hydration mismatches when rendered on the server.
- `useWindowDimensions.tsx` centralises responsive layout data for cards that need to switch between horizontal and vertical presentation.

## Data Access Layer
- All HTTP traffic goes through `src/data/axiosClient.ts`:
  - Configures `baseURL` from `NEXT_PUBLIC_API_URL` with a fallback of `https://api.speclarify.com/api/v1`.
  - Adds the `Authorization` header when an access token is present.
  - On `401` responses, retries once by posting to `/refresh` with the stored `refreshToken`. Successful refreshes update the `accessToken` in `useAuthStore` before replaying the original request.
- `src/services/projectsService.ts` contains thin helpers around the projects endpoints for reuse outside of stores.
- Components never instantiate their own axios clients; they call store actions or these services to keep token handling consistent.

## UI System
- Components follow an **atoms → molecules → organisms → templates** hierarchy within `src/ui`:
  - **Atoms** (e.g., `file-upload/`) wrap primitive Ant Design controls with project-specific behavior.
  - **Molecules** are card-sized building blocks like `confirmRequirementCard`, `duplicateRequirementCard`, or `ambiguousRequirementCard` that encapsulate fetch/update logic.
  - **Organisms** (e.g., `createRequirement`) orchestrate forms and modals composed from molecules/atoms.
  - **Templates** (currently `DashboardLayout`) provide page-level frames.
- Each molecule/organism has an adjacent SCSS module for styles, imported directly by the component.

## Styling and Theming
- Global rules live in `src/app/globals.scss`, including a shared `.container` utility and typography overrides to keep Ant Design fonts aligned with the selected Google font.
- `public/antd.min.css` is generated by `scripts/genAntdCss.tsx` using `@ant-design/static-style-extract`. This script runs automatically before `npm run dev` or `npm run build` to ensure theme tokens stay current.
- SCSS modules sit alongside components to scope styles. Media queries typically reference breakpoints via Flex utilities or the `useWindowDimensions` hook.

## Data Flow Summary
1. User interactions dispatch actions from a store (`useProjectStore`, `useRequirementsStore`).
2. The action triggers an axios request via `axiosClient`.
3. Responses update persisted store state which re-renders subscribed components.
4. Some actions (e.g., `parsePdf`, `updateRequirement`) re-fetch canonical lists to preserve server ordering or derived artifacts like ambiguity results.
5. Ant Design `message` or `Alert` components surface feedback, ensuring consistent UX messaging across steps.

Understanding these building blocks will make it easier to extend new steps, add services, or adjust the UX while preserving Speclarify's established conventions.
